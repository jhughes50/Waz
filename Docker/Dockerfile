FROM nvidia/cuda:12.1.0-cudnn8-runtime-ubuntu20.04 

RUN apt-get update \
 && export TZ="America/New_York" \
 && DEBIAN_FRONTEND=noninteractive apt-get install -y keyboard-configuration \
 && DEBIAN_FRONTEND=noninteractive apt-get install -y tzdata \
 && DEBIAN_FRONTEND=noninteractive apt-get install -y locales \
 && ln -fs "/usr/share/zoneinfo/$TZ" /etc/localtime \
 && dpkg-reconfigure --frontend noninteractive tzdata \
 && apt-get clean

RUN apt-get update \
 && apt-get install -y --no-install-recommends \
 lsb-release \
 libgl1-mesa-dri

ARG DEBIAN_FRONTEND=noninteractive
RUN dpkg-reconfigure locales

# install the basics
RUN apt-get update \
 && apt-get install -y --no-install-recommends \
 vim \
 tmux \
 cmake \
 gcc \
 g++ \
 git \
 build-essential \
 sudo \
 wget \
 curl \
 zip \
 unzip

# install libtorch 
RUN wget https://developer.download.nvidia.com/compute/cuda/repos/wsl-ubuntu/x86_64/cuda-keyring_1.0-1_all.deb \
 && dpkg -i cuda-keyring_1.0-1_all.deb \
 && apt-get update \
 && apt-get -y install cuda
RUN wget https://download.pytorch.org/libtorch/cu121/libtorch-cxx11-abi-shared-with-deps-2.3.1%2Bcu121.zip \
 && unzip *.zip \
 && mv libtorch/ /opt \
 && rm *.zip

# add a user
ARG user_id=1000
ENV USER jason
RUN useradd -U --uid ${user_id} -ms /bin/bash $USER \
 && echo "$USER:$USER" | chpasswd \
 && adduser $USER sudo \
 && echo "$USER ALL=NOPASSWD: ALL" >> /etc/sudoers.d/$USER

# Set locales
RUN sed -i -e 's/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen && \
    locale-gen
ENV LC_ALL en_US.UTF-8
ENV LANG en_US.UTF-8
ENV LANGUAGE en_US:en

USER $USER
COPY .bashrc .
# install Waz depends
RUN sudo apt-get update \
 && sudo apt-get install -y --no-install-recommends \
 libeigen3-dev \
 libgoogle-glog-dev \
 libopencv-dev \
 libtbb-dev \
 libjsoncpp-dev

#install torch for debugging 
RUN sudo apt-get install -y python3-pip
RUN pip3 install torch torchvision torchaudio
RUN pip3 install opencv-python
WORKDIR /home/jason

RUN mkdir include/ src/ cmake/ build/ test/ config/ models/

RUN touch CMakeLists.txt

ENV CUDA_HOME=/usr/local/cuda
